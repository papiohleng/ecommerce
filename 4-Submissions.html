<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Maboneng Art</title>
  <base target="_top">
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    :root{--bg:#fafafa;--text:#18181b;--card:white;--border:#e4e4e7;--accent:#18181b;--gold:#c9a962;--danger:#ef4444;--success:#22c55e;--info:#3b82f6;--warning:#f59e0b;}
    [data-theme="dark"]{--bg:#0a0a0a;--text:#fafafa;--card:#141414;--border:#262626;--accent:#fafafa;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);transition:0.3s;}

    /* Admin Nav */
    .admin-nav{position:fixed;top:0;left:0;right:0;z-index:100;background:var(--card);border-bottom:1px solid var(--border);height:56px;display:flex;align-items:center;padding:0 16px;gap:8px;}
    .nav-brand{font-weight:800;font-size:18px;color:var(--gold);margin-right:16px;white-space:nowrap;}
    .nav-links{display:flex;gap:4px;overflow-x:auto;flex:1;}
    .nav-link{padding:8px 14px;border-radius:8px;font-size:13px;font-weight:600;color:var(--text);text-decoration:none;white-space:nowrap;transition:0.2s;border:1px solid transparent;}
    .nav-link:hover{background:rgba(201,169,98,0.1);border-color:var(--gold);}
    .nav-link.active{background:var(--gold);color:#000;}
    .nav-link .badge{background:var(--danger);color:white;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:4px;}
    .nav-right{margin-left:auto;display:flex;gap:8px;align-items:center;}
    .theme-btn{background:none;border:none;color:var(--text);cursor:pointer;padding:8px;}

    /* Stats Bar */
    .stats-bar{display:flex;gap:12px;padding:72px 16px 16px;overflow-x:auto;}
    .stat-card{flex:0 0 auto;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;min-width:140px;}
    .stat-value{font-size:28px;font-weight:800;}
    .stat-label{font-size:12px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-top:4px;}

    /* Search + Filter */
    .controls{display:flex;gap:12px;padding:12px 16px;flex-wrap:wrap;align-items:center;}
    .search-input{flex:1;min-width:200px;padding:12px 16px;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;outline:none;}
    .search-input:focus{border-color:var(--gold);}
    .filter-btn{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:0.2s;}
    .filter-btn.active{background:var(--gold);color:#000;border-color:var(--gold);}

    /* Order Cards */
    .orders-grid{padding:8px 16px 100px;display:grid;gap:12px;}
    .order-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;transition:0.3s;cursor:pointer;}
    .order-card:hover{border-color:var(--gold);box-shadow:0 4px 20px rgba(201,169,98,0.15);}
    .order-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:8px;}
    .order-ref{font-size:18px;font-weight:800;color:var(--gold);letter-spacing:1px;}
    .order-date{font-size:12px;color:var(--text);opacity:0.6;}
    .order-customer{font-size:15px;font-weight:600;margin-bottom:8px;}
    .order-meta{display:flex;gap:16px;flex-wrap:wrap;font-size:13px;color:var(--text);opacity:0.8;}
    .order-meta span{display:flex;align-items:center;gap:4px;}
    .order-footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px;padding-top:14px;border-top:1px solid var(--border);flex-wrap:wrap;gap:8px;}
    .order-amount{font-size:22px;font-weight:800;}
    .order-actions{display:flex;gap:6px;flex-wrap:wrap;}

    /* Status Badges */
    .status-badge{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;}
    .status-new{background:rgba(59,130,246,0.15);color:var(--info);}
    .status-processing{background:rgba(245,158,11,0.15);color:var(--warning);}
    .status-shipped{background:rgba(168,85,247,0.15);color:#a855f7;}
    .status-delivered{background:rgba(34,197,94,0.15);color:var(--success);}
    .status-cancelled{background:rgba(239,68,68,0.15);color:var(--danger);}
    .status-refunded{background:rgba(107,114,128,0.15);color:#6b7280;}
    .payment-paid{color:var(--success);}
    .payment-pending{color:var(--warning);}

    /* Action Buttons */
    .action-btn{padding:8px 14px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:0.2s;display:flex;align-items:center;gap:4px;}
    .action-btn:hover{border-color:var(--gold);background:rgba(201,169,98,0.1);}
    .action-btn.danger:hover{border-color:var(--danger);background:rgba(239,68,68,0.1);color:var(--danger);}
    .action-btn.primary{background:var(--gold);color:#000;border-color:var(--gold);}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;display:none;justify-content:center;align-items:center;padding:20px;}
    .modal-overlay.open{display:flex;}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:700px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
    .modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--card);z-index:5;border-radius:16px 16px 0 0;}
    .modal-header h2{font-size:18px;font-weight:800;color:var(--gold);}
    .modal-close{background:none;border:none;color:var(--text);font-size:24px;cursor:pointer;padding:4px;}
    .modal-body{padding:24px;}
    .modal-section{margin-bottom:20px;}
    .modal-section h3{font-size:14px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border);}
    .detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;}
    .detail-item{background:rgba(0,0,0,0.05);padding:12px;border-radius:8px;}
    .detail-item label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--gold);display:block;margin-bottom:4px;}
    .detail-item span{font-size:15px;font-weight:600;}
    .detail-item select,.detail-item input{width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px;margin-top:4px;}

    /* Comments */
    .comment{padding:10px 14px;background:rgba(0,0,0,0.03);border-radius:8px;margin-bottom:8px;border-left:3px solid var(--gold);}
    .comment-author{font-weight:700;font-size:13px;color:var(--gold);}
    .comment-time{font-size:11px;color:var(--text);opacity:0.5;margin-left:8px;}
    .comment-text{font-size:14px;margin-top:4px;}
    .comment-input-row{display:flex;gap:8px;margin-top:12px;}
    .comment-input-row input{flex:1;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;}
    .comment-input-row button{padding:10px 20px;background:var(--gold);color:#000;border:none;border-radius:8px;font-weight:700;cursor:pointer;}

    /* Items Table */
    .items-table{width:100%;border-collapse:collapse;}
    .items-table th,.items-table td{padding:10px;text-align:left;border-bottom:1px solid var(--border);}
    .items-table th{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--gold);}

    /* Email Modal */
    .email-form input,.email-form textarea{width:100%;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;margin-bottom:10px;}
    .email-form textarea{min-height:120px;resize:vertical;}

    /* Delete Modal */
    .delete-form input{width:100%;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;margin-bottom:10px;}
    .delete-confirm-btn{width:100%;padding:14px;background:var(--danger);color:white;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;}

    .empty-state{text-align:center;padding:80px 20px;}
    .empty-state h3{font-size:20px;margin-bottom:8px;}
    .empty-state p{color:var(--text);opacity:0.5;}
    .loading{text-align:center;padding:80px 20px;font-size:16px;}
  </style>
</head>
<body>

  <nav class="admin-nav">
    <span class="nav-brand">Maboneng Art</span>
    <div class="nav-links">
      <a href="?action=shop" class="nav-link">Shop</a>
      <a href="?action=admin" class="nav-link active">Orders</a>
      <a href="?action=inventory" class="nav-link">Inventory</a>
      <a href="?action=new-inventory" class="nav-link">+ New</a>
      <a href="?action=transactions" class="nav-link">Transactions</a>
      <a href="?action=deleted" class="nav-link">Deleted <span class="badge" id="deletedBadge">0</span></a>
    </div>
    <div class="nav-right">
      <button class="theme-btn" id="themeToggle"><i data-feather="moon"></i></button>
    </div>
  </nav>

  <div class="stats-bar" id="statsBar">
    <div class="stat-card"><div class="stat-value" id="statTotal">-</div><div class="stat-label">Total Orders</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--info)" id="statNew">-</div><div class="stat-label">New</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--warning)" id="statProcessing">-</div><div class="stat-label">Processing</div></div>
    <div class="stat-card"><div class="stat-value" style="color:#a855f7" id="statShipped">-</div><div class="stat-label">Shipped</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--success)" id="statDelivered">-</div><div class="stat-label">Delivered</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--gold)" id="statRevenue">-</div><div class="stat-label">Revenue</div></div>
  </div>

  <div class="controls">
    <input type="text" class="search-input" id="searchInput" placeholder="Search by reference, name, email, status...">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="new">New</button>
    <button class="filter-btn" data-filter="processing">Processing</button>
    <button class="filter-btn" data-filter="shipped">Shipped</button>
    <button class="filter-btn" data-filter="delivered">Delivered</button>
    <button class="filter-btn" data-filter="pending">Unpaid</button>
  </div>

  <div class="loading" id="loadingState">Loading orders...</div>
  <div class="orders-grid" id="ordersGrid" style="display:none;"></div>
  <div class="empty-state" id="emptyState" style="display:none;"><h3>No orders found</h3><p>Orders will appear here when customers checkout.</p></div>

  <!-- View Order Modal -->
  <div class="modal-overlay" id="viewModal">
    <div class="modal">
      <div class="modal-header"><h2 id="modalRef">Order Details</h2><button class="modal-close" onclick="closeModal('viewModal')">X</button></div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- Email Modal -->
  <div class="modal-overlay" id="emailModal">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header"><h2>Send Email</h2><button class="modal-close" onclick="closeModal('emailModal')">X</button></div>
      <div class="modal-body email-form">
        <input type="hidden" id="emailRef">
        <input type="email" id="emailTo" placeholder="Recipient email">
        <input type="text" id="emailSubject" placeholder="Subject">
        <textarea id="emailBody" placeholder="Message body..."></textarea>
        <button class="action-btn primary" style="width:100%;justify-content:center;padding:14px;font-size:16px;" onclick="sendEmailAction()">Send Email</button>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-width:440px;">
      <div class="modal-header"><h2 style="color:var(--danger)">Cancel Order</h2><button class="modal-close" onclick="closeModal('deleteModal')">X</button></div>
      <div class="modal-body delete-form">
        <input type="hidden" id="deleteRef">
        <p style="margin-bottom:16px;">This will move the order to the Deleted archive. You can restore it later.</p>
        <input type="text" id="deleteReason" placeholder="Reason for cancellation *">
        <button class="delete-confirm-btn" onclick="confirmDelete()">Confirm Cancellation</button>
      </div>
    </div>
  </div>

<script>
  feather.replace();
  var orders = [], currentFilter = 'all', selectedOrder = null;

  // Theme
  document.getElementById('themeToggle').onclick = function(){
    var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
  };

  // Filters
  document.querySelectorAll('.filter-btn').forEach(function(b){
    b.onclick = function(){
      document.querySelectorAll('.filter-btn').forEach(function(x){x.classList.remove('active');});
      b.classList.add('active');
      currentFilter = b.dataset.filter;
      renderOrders();
    };
  });

  document.getElementById('searchInput').addEventListener('input', function(){ renderOrders(); });

  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function statusClass(s){
    s = (s||'new').toLowerCase();
    if(s==='new') return 'status-new';
    if(s==='processing') return 'status-processing';
    if(s==='shipped') return 'status-shipped';
    if(s==='delivered') return 'status-delivered';
    if(s==='cancelled') return 'status-cancelled';
    if(s==='refunded') return 'status-refunded';
    return 'status-new';
  }

  function renderOrders(){
    var search = document.getElementById('searchInput').value.toLowerCase();
    var filtered = orders.filter(function(o){
      if(currentFilter !== 'all'){
        if(currentFilter === 'pending' && o.paymentStatus !== 'pending') return false;
        else if(currentFilter !== 'pending' && o.status !== currentFilter) return false;
      }
      if(search){
        var hay = (o.reference+' '+o.customerName+' '+o.customerSurname+' '+o.email+' '+o.status+' '+o.paymentStatus).toLowerCase();
        if(hay.indexOf(search) === -1) return false;
      }
      return true;
    });

    var grid = document.getElementById('ordersGrid');
    var empty = document.getElementById('emptyState');

    if(filtered.length === 0){
      grid.style.display = 'none';
      empty.style.display = 'block';
      return;
    }

    empty.style.display = 'none';
    grid.style.display = 'grid';

    grid.innerHTML = filtered.map(function(o){
      var balance = o.balance !== undefined ? o.balance : o.totalAmount;
      return '<div class="order-card" onclick="viewOrder(\''+esc(o.reference)+'\')">'
        +'<div class="order-header">'
        +'<div><div class="order-ref">'+esc(o.reference)+'</div><div class="order-date">'+formatDate(o.timestamp)+'</div></div>'
        +'<span class="status-badge '+statusClass(o.status)+'">'+esc(o.status)+'</span>'
        +'</div>'
        +'<div class="order-customer">'+esc(o.customerName)+' '+esc(o.customerSurname)+'</div>'
        +'<div class="order-meta">'
        +'<span><i data-feather="mail" style="width:14px;height:14px;"></i> '+esc(o.email)+'</span>'
        +'<span><i data-feather="package" style="width:14px;height:14px;"></i> '+o.itemCount+' items</span>'
        +'<span><i data-feather="credit-card" style="width:14px;height:14px;"></i> '+esc(o.paymentMethod)+' (<span class="payment-'+o.paymentStatus+'">'+esc(o.paymentStatus)+'</span>)</span>'
        +(o.commentCount ? '<span><i data-feather="message-square" style="width:14px;height:14px;"></i> '+o.commentCount+'</span>' : '')
        +'</div>'
        +'<div class="order-footer">'
        +'<div><div class="order-amount">$'+o.totalAmount.toFixed(2)+'</div>'
        +(balance > 0 ? '<div style="font-size:12px;color:var(--danger);">Balance: $'+balance.toFixed(2)+'</div>' : '<div style="font-size:12px;color:var(--success);">Paid</div>')
        +'</div>'
        +'<div class="order-actions">'
        +'<button class="action-btn" onclick="event.stopPropagation();viewOrder(\''+esc(o.reference)+'\')"><i data-feather="eye" style="width:14px;height:14px;"></i> View</button>'
        +'<button class="action-btn" onclick="event.stopPropagation();openEmail(\''+esc(o.reference)+'\',\''+esc(o.email)+'\')"><i data-feather="mail" style="width:14px;height:14px;"></i></button>'
        +'<button class="action-btn danger" onclick="event.stopPropagation();openDelete(\''+esc(o.reference)+'\')"><i data-feather="trash-2" style="width:14px;height:14px;"></i></button>'
        +'</div></div></div>';
    }).join('');
    feather.replace();
  }

  function updateStats(){
    var stats = {total:orders.length,new:0,processing:0,shipped:0,delivered:0,revenue:0};
    orders.forEach(function(o){
      if(stats.hasOwnProperty(o.status)) stats[o.status]++;
      stats.revenue += o.totalAmount;
    });
    document.getElementById('statTotal').textContent = stats.total;
    document.getElementById('statNew').textContent = stats.new;
    document.getElementById('statProcessing').textContent = stats.processing;
    document.getElementById('statShipped').textContent = stats.shipped;
    document.getElementById('statDelivered').textContent = stats.delivered;
    document.getElementById('statRevenue').textContent = '$'+stats.revenue.toFixed(0);
  }

  function viewOrder(ref){
    selectedOrder = orders.find(function(o){return o.reference === ref;});
    if(!selectedOrder) return;
    document.getElementById('modalRef').textContent = 'Order: ' + ref;

    var items = [];
    try { items = JSON.parse(selectedOrder.itemsJson || '[]'); } catch(e){}

    var html = '<div class="modal-section"><h3>Customer</h3><div class="detail-grid">'
      +'<div class="detail-item"><label>Name</label><span>'+esc(selectedOrder.customerName)+' '+esc(selectedOrder.customerSurname)+'</span></div>'
      +'<div class="detail-item"><label>Email</label><span>'+esc(selectedOrder.email)+'</span></div>'
      +'<div class="detail-item"><label>Phone</label><span>'+esc(selectedOrder.phone||'N/A')+'</span></div>'
      +'<div class="detail-item"><label>Address</label><span>'+esc(selectedOrder.shippingAddress)+', '+esc(selectedOrder.city)+' '+esc(selectedOrder.postalCode)+'</span></div>'
      +'</div></div>';

    html += '<div class="modal-section"><h3>Status & Payment</h3><div class="detail-grid">'
      +'<div class="detail-item"><label>Status</label><select onchange="updateField(\''+ref+'\',\'status\',this.value)">'
      +['new','processing','shipped','delivered','cancelled','refunded'].map(function(s){return '<option value="'+s+'"'+(selectedOrder.status===s?' selected':'')+'>'+s.charAt(0).toUpperCase()+s.slice(1)+'</option>';}).join('')
      +'</select></div>'
      +'<div class="detail-item"><label>Payment Status</label><select onchange="updateField(\''+ref+'\',\'paymentStatus\',this.value)">'
      +['pending','paid','partial','refunded'].map(function(s){return '<option value="'+s+'"'+(selectedOrder.paymentStatus===s?' selected':'')+'>'+s.charAt(0).toUpperCase()+s.slice(1)+'</option>';}).join('')
      +'</select></div>'
      +'<div class="detail-item"><label>Payment Method</label><span>'+esc(selectedOrder.paymentMethod)+'</span></div>'
      +'<div class="detail-item"><label>Tracking Number</label><input value="'+esc(selectedOrder.trackingNumber)+'" onchange="updateField(\''+ref+'\',\'trackingNumber\',this.value)" placeholder="Enter tracking #"></div>'
      +'</div></div>';

    html += '<div class="modal-section"><h3>Items ('+items.length+')</h3><table class="items-table"><tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr>';
    items.forEach(function(it){
      html += '<tr><td>'+esc(it.name)+'</td><td>'+it.quantity+'</td><td>$'+parseFloat(it.price).toFixed(2)+'</td><td>$'+(it.price*it.quantity).toFixed(2)+'</td></tr>';
    });
    html += '</table></div>';

    html += '<div class="modal-section"><h3>Financials</h3><div class="detail-grid">'
      +'<div class="detail-item"><label>Subtotal</label><span>$'+selectedOrder.subtotal.toFixed(2)+'</span></div>'
      +'<div class="detail-item"><label>Shipping</label><span>'+(selectedOrder.shippingFee===0?'FREE':'$'+selectedOrder.shippingFee.toFixed(2))+'</span></div>'
      +'<div class="detail-item"><label>Savings</label><span style="color:var(--success)">$'+selectedOrder.totalSavings.toFixed(2)+'</span></div>'
      +'<div class="detail-item"><label>Total</label><span style="font-size:20px;color:var(--gold)">$'+selectedOrder.totalAmount.toFixed(2)+'</span></div>'
      +'</div></div>';

    // Comments section
    html += '<div class="modal-section"><h3>Comments & History</h3><div id="commentsContainer">Loading...</div>'
      +'<div class="comment-input-row"><input type="text" id="newComment" placeholder="Add a comment...">'
      +'<button onclick="addComment(\''+esc(ref)+'\')">Post</button></div></div>';

    // Actions
    html += '<div class="modal-section" style="display:flex;gap:8px;flex-wrap:wrap;">'
      +'<button class="action-btn primary" onclick="sendConfirmation(\''+esc(ref)+'\')"><i data-feather="send" style="width:14px;height:14px;"></i> Send Confirmation</button>'
      +'<button class="action-btn" onclick="openEmail(\''+esc(ref)+'\',\''+esc(selectedOrder.email)+'\');closeModal(\'viewModal\')"><i data-feather="mail" style="width:14px;height:14px;"></i> Email Customer</button>'
      +'<button class="action-btn danger" onclick="openDelete(\''+esc(ref)+'\');closeModal(\'viewModal\')"><i data-feather="trash-2" style="width:14px;height:14px;"></i> Cancel Order</button>'
      +'</div>';

    document.getElementById('modalBody').innerHTML = html;
    feather.replace();
    document.getElementById('viewModal').classList.add('open');
    loadComments(ref);
  }

  function loadComments(ref){
    if(typeof google !== 'undefined' && google.script && google.script.run){
      google.script.run.withSuccessHandler(function(r){
        renderComments(r.comments || []);
      }).withFailureHandler(function(){
        document.getElementById('commentsContainer').innerHTML = '<p style="color:var(--danger)">Failed to load comments</p>';
      }).getCommentsForOrder(ref);
    } else {
      renderComments([{author:'SYSTEM',text:'Order created',timestamp:new Date().toISOString()}]);
    }
  }

  function renderComments(comments){
    var el = document.getElementById('commentsContainer');
    if(!comments.length){el.innerHTML='<p style="opacity:0.5;">No comments yet</p>';return;}
    el.innerHTML = comments.map(function(c){
      return '<div class="comment"><span class="comment-author">'+esc(c.author)+'</span><span class="comment-time">'+formatDate(c.timestamp)+'</span><div class="comment-text">'+esc(c.text)+'</div></div>';
    }).join('');
  }

  function addComment(ref){
    var input = document.getElementById('newComment');
    var text = input.value.trim();
    if(!text) return;
    input.value = '';
    if(typeof google !== 'undefined' && google.script && google.script.run){
      google.script.run.withSuccessHandler(function(){loadComments(ref);}).addComment(ref, text, 'Admin');
    } else {
      var el = document.getElementById('commentsContainer');
      el.innerHTML = '<div class="comment"><span class="comment-author">Admin</span><span class="comment-time">Just now</span><div class="comment-text">'+esc(text)+'</div></div>' + el.innerHTML;
    }
  }

  function updateField(ref, field, value){
    if(typeof google !== 'undefined' && google.script && google.script.run){
      google.script.run.withSuccessHandler(function(){loadOrders();}).updateOrderField({reference:ref,field:field,value:value});
    } else {
      var o = orders.find(function(x){return x.reference===ref;});
      if(o) o[field] = value;
      renderOrders(); updateStats();
    }
  }

  function sendConfirmation(ref){
    if(typeof google !== 'undefined' && google.script && google.script.run){
      google.script.run.withSuccessHandler(function(r){alert(r.success?'Confirmation sent!':'Error: '+(r.error||'Unknown'));}).sendOrderConfirmation({reference:ref});
    } else { alert('Demo: Confirmation would be sent for '+ref); }
  }

  function openEmail(ref, email){
    document.getElementById('emailRef').value = ref;
    document.getElementById('emailTo').value = email;
    document.getElementById('emailSubject').value = 'Regarding Order: ' + ref;
    document.getElementById('emailBody').value = '';
    document.getElementById('emailModal').classList.add('open');
  }

  function sendEmailAction(){
    var data = {reference:document.getElementById('emailRef').value,to:document.getElementById('emailTo').value,subject:document.getElementById('emailSubject').value,body:document.getElementById('emailBody').value};
    if(!data.to||!data.subject||!data.body){alert('Please fill all fields');return;}
    if(typeof google !== 'undefined' && google.script && google.script.run){
      google.script.run.withSuccessHandler(function(r){alert(r.success?'Email sent!':'Error: '+r.error);closeModal('emailModal');}).sendCustomEmail(data);
    } else { alert('Demo: Email would be sent to '+data.to); closeModal('emailModal'); }
  }

  function openDelete(ref){
    document.getElementById('deleteRef').value = ref;
    document.getElementById('deleteReason').value = '';
    document.getElementById('deleteModal').classList.add('open');
  }

  function confirmDelete(){
    var ref = document.getElementById('deleteRef').value;
    var reason = document.getElementById('deleteReason').value.trim();
    if(!reason){alert('Please enter a reason');return;}
    if(typeof google !== 'undefined' && google.script && google.script.run){
      google.script.run.withSuccessHandler(function(r){
        if(r.success){closeModal('deleteModal');loadOrders();}
        else alert('Error: '+r.error);
      }).moveToDeleted({reference:ref,deleteReason:reason,deletedBy:'Admin'});
    } else {
      orders = orders.filter(function(o){return o.reference!==ref;});
      closeModal('deleteModal'); renderOrders(); updateStats();
    }
  }

  function closeModal(id){ document.getElementById(id).classList.remove('open'); }

  function formatDate(d){
    if(!d) return '';
    try{ var dt=new Date(d); return dt.toLocaleDateString('en-ZA',{day:'2-digit',month:'short',year:'numeric'})+' '+dt.toLocaleTimeString('en-ZA',{hour:'2-digit',minute:'2-digit'}); }catch(e){return String(d);}
  }

  function loadOrders(){
    if(typeof google !== 'undefined' && google.script && google.script.run){
      google.script.run.withSuccessHandler(function(r){
        orders = r.orders || [];
        document.getElementById('loadingState').style.display='none';
        renderOrders(); updateStats();
      }).withFailureHandler(function(e){
        document.getElementById('loadingState').innerHTML='<p style="color:var(--danger)">Error loading orders: '+esc(e.message)+'</p>';
      }).getAllOrdersWithComments();
    } else { loadDemoOrders(); }
  }

  function loadDeletedCount(){
    if(typeof google !== 'undefined' && google.script && google.script.run){
      google.script.run.withSuccessHandler(function(r){
        document.getElementById('deletedBadge').textContent = r.deletedCount || 0;
      }).getDeletedOrdersCount();
    }
  }

  function loadDemoOrders(){
    orders = [
      {reference:'2602DEMO001',timestamp:new Date().toISOString(),status:'new',customerName:'John',customerSurname:'Doe',email:'john@example.com',phone:'+27123456789',country:'South Africa',shippingAddress:'123 Art Street',city:'Johannesburg',postalCode:'2000',itemsJson:'[{"name":"Abstract Gold Horizon","quantity":1,"price":89,"original":299}]',itemCount:1,subtotal:89,shippingFee:0,discountAmount:0,totalSavings:210,totalAmount:89,paymentMethod:'eft',paymentStatus:'pending',paypalTransaction:'',eftReference:'',confirmationSent:false,trackingNumber:'',notes:'',lastUpdated:'',commentCount:1,balance:89},
      {reference:'2602SMITH002',timestamp:new Date(Date.now()-86400000).toISOString(),status:'processing',customerName:'Jane',customerSurname:'Smith',email:'jane@example.com',phone:'',country:'USA',shippingAddress:'456 Canvas Ave',city:'New York',postalCode:'10001',itemsJson:'[{"name":"Urban Pulse Sculpture","quantity":2,"price":179,"original":450}]',itemCount:2,subtotal:358,shippingFee:0,discountAmount:0,totalSavings:542,totalAmount:358,paymentMethod:'paypal',paymentStatus:'paid',paypalTransaction:'PP-123',eftReference:'',confirmationSent:true,trackingNumber:'TRK-789',notes:'',lastUpdated:'',commentCount:3,balance:0}
    ];
    document.getElementById('loadingState').style.display='none';
    renderOrders(); updateStats();
  }

  // Init
  loadOrders();
  loadDeletedCount();
</script>
</body>
</html>
