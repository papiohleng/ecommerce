<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transactions - Maboneng Art</title>
  <base target="_top">
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    :root{--bg:#fafafa;--text:#18181b;--card:white;--border:#e4e4e7;--accent:#18181b;--gold:#c9a962;--danger:#ef4444;--success:#22c55e;--info:#3b82f6;--warning:#f59e0b;}
    [data-theme="dark"]{--bg:#0a0a0a;--text:#fafafa;--card:#141414;--border:#262626;--accent:#fafafa;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);transition:0.3s;}

    .admin-nav{position:fixed;top:0;left:0;right:0;z-index:100;background:var(--card);border-bottom:1px solid var(--border);height:56px;display:flex;align-items:center;padding:0 16px;gap:8px;}
    .nav-brand{font-weight:800;font-size:18px;color:var(--gold);margin-right:16px;white-space:nowrap;}
    .nav-links{display:flex;gap:4px;overflow-x:auto;flex:1;}
    .nav-link{padding:8px 14px;border-radius:8px;font-size:13px;font-weight:600;color:var(--text);text-decoration:none;white-space:nowrap;transition:0.2s;border:1px solid transparent;}
    .nav-link:hover{background:rgba(201,169,98,0.1);border-color:var(--gold);}
    .nav-link.active{background:var(--gold);color:#000;}
    .nav-right{margin-left:auto;display:flex;gap:8px;align-items:center;}
    .theme-btn{background:none;border:none;color:var(--text);cursor:pointer;padding:8px;}

    /* Tabs */
    .tabs{display:flex;gap:4px;padding:72px 16px 12px;overflow-x:auto;}
    .tab{padding:10px 20px;border-radius:8px;font-size:14px;font-weight:600;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;white-space:nowrap;transition:0.2s;}
    .tab.active{background:var(--gold);color:#000;border-color:var(--gold);}

    /* Summary Cards */
    .summary-bar{display:flex;gap:12px;padding:12px 16px;overflow-x:auto;}
    .summary-card{flex:0 0 auto;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;min-width:160px;}
    .summary-value{font-size:24px;font-weight:800;}
    .summary-label{font-size:11px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-top:4px;}

    /* Controls */
    .controls{display:flex;gap:12px;padding:8px 16px;flex-wrap:wrap;align-items:center;}
    .search-input{flex:1;min-width:200px;padding:12px 16px;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;outline:none;}
    .search-input:focus{border-color:var(--gold);}
    .add-btn{padding:10px 20px;background:var(--gold);color:#000;border:none;border-radius:10px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;}

    /* Ledger Table */
    .table-wrapper{padding:8px 16px 100px;overflow-x:auto;}
    .ledger-table{width:100%;border-collapse:collapse;min-width:700px;}
    .ledger-table th{padding:12px;text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--gold);border-bottom:2px solid var(--border);position:sticky;top:0;background:var(--bg);}
    .ledger-table td{padding:12px;font-size:14px;border-bottom:1px solid var(--border);}
    .ledger-table tr:hover{background:rgba(201,169,98,0.05);}
    .debit{color:var(--danger);font-weight:700;}
    .credit{color:var(--success);font-weight:700;}
    .type-badge{font-size:11px;padding:3px 10px;border-radius:20px;font-weight:700;}
    .type-CHARGE{background:rgba(239,68,68,0.1);color:var(--danger);}
    .type-PAYMENT{background:rgba(34,197,94,0.1);color:var(--success);}
    .type-REFUND{background:rgba(168,85,247,0.1);color:#a855f7;}
    .type-ADJUSTMENT{background:rgba(245,158,11,0.1);color:var(--warning);}
    .delete-txn{background:none;border:none;color:var(--danger);cursor:pointer;opacity:0.5;transition:0.2s;}
    .delete-txn:hover{opacity:1;}

    /* Add Transaction Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;display:none;justify-content:center;align-items:center;padding:20px;}
    .modal-overlay.open{display:flex;}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:500px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
    .modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
    .modal-header h2{font-size:18px;font-weight:800;color:var(--gold);}
    .modal-close{background:none;border:none;color:var(--text);font-size:24px;cursor:pointer;}
    .modal-body{padding:24px;}
    .form-field{margin-bottom:14px;}
    .form-field label{display:block;font-size:12px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;}
    .form-field input,.form-field select,.form-field textarea{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;}
    .form-submit{width:100%;padding:14px;background:var(--gold);color:#000;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;margin-top:8px;}

    /* P&L Section */
    .pnl-section{padding:16px;}
    .pnl-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));}
    .pnl-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;}
    .pnl-card h4{font-size:12px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
    .pnl-card .value{font-size:28px;font-weight:800;}

    .loading{text-align:center;padding:80px 20px;font-size:16px;}
    .empty-state{text-align:center;padding:60px 20px;opacity:0.5;}
  </style>
</head>
<body>

  <nav class="admin-nav">
    <span class="nav-brand">Maboneng Art</span>
    <div class="nav-links">
      <a href="?action=shop" class="nav-link">Shop</a>
      <a href="?action=admin" class="nav-link">Orders</a>
      <a href="?action=inventory" class="nav-link">Inventory</a>
      <a href="?action=new-inventory" class="nav-link">+ New</a>
      <a href="?action=transactions" class="nav-link active">Transactions</a>
      <a href="?action=deleted" class="nav-link">Deleted</a>
    </div>
    <div class="nav-right"><button class="theme-btn" id="themeToggle"><i data-feather="moon"></i></button></div>
  </nav>

  <div class="tabs">
    <button class="tab active" data-tab="ledger">General Ledger</button>
    <button class="tab" data-tab="client">Client Accounts</button>
    <button class="tab" data-tab="pnl">Profit & Loss</button>
  </div>

  <!-- GENERAL LEDGER TAB -->
  <div id="tab-ledger">
    <div class="summary-bar" id="summaryBar">
      <div class="summary-card"><div class="summary-value" id="sumCharges">$0</div><div class="summary-label">Total Charges</div></div>
      <div class="summary-card"><div class="summary-value" style="color:var(--success)" id="sumPayments">$0</div><div class="summary-label">Total Payments</div></div>
      <div class="summary-card"><div class="summary-value" style="color:var(--gold)" id="sumBalance">$0</div><div class="summary-label">Outstanding</div></div>
      <div class="summary-card"><div class="summary-value" id="sumCount">0</div><div class="summary-label">Transactions</div></div>
    </div>

    <div class="controls">
      <input type="text" class="search-input" id="searchInput" placeholder="Search by reference, description, type...">
      <button class="add-btn" onclick="openAddTxn()"><i data-feather="plus" style="width:16px;height:16px;"></i> Add Transaction</button>
    </div>

    <div class="loading" id="loadingState">Loading transactions...</div>
    <div class="table-wrapper" id="tableWrapper" style="display:none;">
      <table class="ledger-table">
        <thead><tr><th>Date</th><th>Reference</th><th>Description</th><th>Type</th><th>Debit</th><th>Credit</th><th>Balance</th><th>By</th><th></th></tr></thead>
        <tbody id="ledgerBody"></tbody>
      </table>
    </div>
    <div class="empty-state" id="emptyState" style="display:none;"><p>No transactions found</p></div>
  </div>

  <!-- CLIENT ACCOUNTS TAB -->
  <div id="tab-client" style="display:none;padding:16px;">
    <div class="controls" style="padding:0 0 16px;"><input type="text" class="search-input" id="clientSearch" placeholder="Search client by reference..."></div>
    <div id="clientGrid" style="display:grid;gap:12px;"></div>
  </div>

  <!-- P&L TAB -->
  <div id="tab-pnl" style="display:none;">
    <div class="pnl-section">
      <h2 style="font-size:24px;font-weight:800;margin-bottom:20px;">Profit & Loss Summary</h2>
      <div class="pnl-grid">
        <div class="pnl-card"><h4>Total Revenue</h4><div class="value" id="pnlRevenue" style="color:var(--success)">$0</div></div>
        <div class="pnl-card"><h4>Total Payments Received</h4><div class="value" id="pnlPayments" style="color:var(--success)">$0</div></div>
        <div class="pnl-card"><h4>Outstanding Receivables</h4><div class="value" id="pnlOutstanding" style="color:var(--warning)">$0</div></div>
        <div class="pnl-card"><h4>VAT (15%)</h4><div class="value" id="pnlVAT" style="color:var(--info)">$0</div></div>
        <div class="pnl-card"><h4>Revenue Excl. VAT</h4><div class="value" id="pnlExVAT">$0</div></div>
        <div class="pnl-card"><h4>Refunds Issued</h4><div class="value" id="pnlRefunds" style="color:var(--danger)">$0</div></div>
      </div>
    </div>
  </div>

  <!-- Add Transaction Modal -->
  <div class="modal-overlay" id="addTxnModal">
    <div class="modal">
      <div class="modal-header"><h2>Add Transaction</h2><button class="modal-close" onclick="closeTxnModal()">X</button></div>
      <div class="modal-body">
        <div class="form-field"><label>Order Reference *</label><input type="text" id="txn_ref" placeholder="e.g. 2602SMITH002"></div>
        <div class="form-field"><label>Date</label><input type="date" id="txn_date"></div>
        <div class="form-field"><label>Description *</label><input type="text" id="txn_desc" placeholder="e.g. PayPal Payment"></div>
        <div class="form-field"><label>Amount ($) *</label><input type="number" id="txn_amount" step="0.01" placeholder="Positive=charge, Negative=payment"></div>
        <div class="form-field"><label>Type</label><select id="txn_type"><option value="CHARGE">Charge (Debit)</option><option value="PAYMENT">Payment (Credit)</option><option value="REFUND">Refund</option><option value="ADJUSTMENT">Adjustment</option></select></div>
        <button class="form-submit" onclick="submitTxn()">Add Transaction</button>
      </div>
    </div>
  </div>

<script>
  feather.replace();
  var transactions = [], currentTab = 'ledger';

  document.getElementById('themeToggle').onclick = function(){
    var d = document.documentElement.getAttribute('data-theme')==='dark';
    document.documentElement.setAttribute('data-theme', d?'light':'dark');
  };

  // Tab switching
  document.querySelectorAll('.tab').forEach(function(t){
    t.onclick = function(){
      document.querySelectorAll('.tab').forEach(function(x){x.classList.remove('active');});
      t.classList.add('active');
      currentTab = t.dataset.tab;
      document.getElementById('tab-ledger').style.display = currentTab==='ledger'?'block':'none';
      document.getElementById('tab-client').style.display = currentTab==='client'?'block':'none';
      document.getElementById('tab-pnl').style.display = currentTab==='pnl'?'block':'none';
      if(currentTab==='client') renderClientAccounts();
      if(currentTab==='pnl') renderPnL();
    };
  });

  document.getElementById('searchInput').addEventListener('input', function(){ renderLedger(); });
  document.getElementById('clientSearch').addEventListener('input', function(){ renderClientAccounts(); });

  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function renderLedger(){
    var search = document.getElementById('searchInput').value.toLowerCase();
    var filtered = transactions.filter(function(t){
      if(!search) return true;
      return (t.reference+' '+t.description+' '+t.type+' '+t.createdBy).toLowerCase().indexOf(search) > -1;
    });

    // Sort by date
    filtered.sort(function(a,b){ return new Date(a.date) - new Date(b.date); });

    var body = document.getElementById('ledgerBody');
    var wrapper = document.getElementById('tableWrapper');
    var empty = document.getElementById('emptyState');

    if(filtered.length===0){ wrapper.style.display='none'; empty.style.display='block'; return; }
    empty.style.display='none'; wrapper.style.display='block';

    var runningBalance = 0;
    body.innerHTML = filtered.map(function(t){
      runningBalance += t.amount;
      return '<tr>'
        +'<td>'+esc(t.date)+'</td>'
        +'<td><strong style="color:var(--gold)">'+esc(t.reference)+'</strong></td>'
        +'<td>'+esc(t.description)+'</td>'
        +'<td><span class="type-badge type-'+esc(t.type)+'">'+esc(t.type)+'</span></td>'
        +'<td class="debit">'+(t.amount >= 0 ? '$'+t.amount.toFixed(2) : '')+'</td>'
        +'<td class="credit">'+(t.amount < 0 ? '$'+Math.abs(t.amount).toFixed(2) : '')+'</td>'
        +'<td style="font-weight:700;color:'+(runningBalance>0?'var(--danger)':'var(--success)')+'">$'+runningBalance.toFixed(2)+'</td>'
        +'<td style="font-size:12px;opacity:0.6">'+esc(t.createdBy)+'</td>'
        +'<td><button class="delete-txn" onclick="deleteTxn(\''+esc(t.id)+'\')"><i data-feather="trash-2" style="width:14px;height:14px;"></i></button></td>'
        +'</tr>';
    }).join('');
    feather.replace();

    // Summary
    var charges = 0, payments = 0;
    transactions.forEach(function(t){ if(t.amount>=0) charges+=t.amount; else payments+=Math.abs(t.amount); });
    document.getElementById('sumCharges').textContent = '$'+charges.toFixed(2);
    document.getElementById('sumPayments').textContent = '$'+payments.toFixed(2);
    document.getElementById('sumBalance').textContent = '$'+(charges-payments).toFixed(2);
    document.getElementById('sumCount').textContent = transactions.length;
  }

  function renderClientAccounts(){
    var search = document.getElementById('clientSearch').value.toLowerCase();
    var refMap = {};
    transactions.forEach(function(t){
      if(!refMap[t.reference]) refMap[t.reference] = {ref:t.reference, charges:0, payments:0, txns:[]};
      if(t.amount>=0) refMap[t.reference].charges += t.amount;
      else refMap[t.reference].payments += Math.abs(t.amount);
      refMap[t.reference].txns.push(t);
    });

    var clients = Object.values(refMap).filter(function(c){
      if(!search) return true;
      return c.ref.toLowerCase().indexOf(search) > -1;
    });

    var grid = document.getElementById('clientGrid');
    grid.innerHTML = clients.map(function(c){
      var balance = c.charges - c.payments;
      return '<div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;">'
        +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">'
        +'<span style="font-size:18px;font-weight:800;color:var(--gold)">'+esc(c.ref)+'</span>'
        +'<span style="font-size:18px;font-weight:800;color:'+(balance>0?'var(--danger)':'var(--success)')+'">$'+balance.toFixed(2)+'</span>'
        +'</div>'
        +'<div style="display:flex;gap:20px;font-size:13px;">'
        +'<span>Charges: <strong class="debit">$'+c.charges.toFixed(2)+'</strong></span>'
        +'<span>Payments: <strong class="credit">$'+c.payments.toFixed(2)+'</strong></span>'
        +'<span>Txns: <strong>'+c.txns.length+'</strong></span>'
        +'</div>'
        +'<div style="margin-top:12px;"><button class="add-btn" style="font-size:12px;padding:8px 14px;" onclick="sendStatement(\''+esc(c.ref)+'\')"><i data-feather="send" style="width:12px;height:12px;"></i> Email Statement</button></div>'
        +'</div>';
    }).join('');
    feather.replace();
  }

  function renderPnL(){
    var charges=0, payments=0, refunds=0;
    transactions.forEach(function(t){
      if(t.type==='REFUND') refunds += Math.abs(t.amount);
      else if(t.amount>=0) charges += t.amount;
      else payments += Math.abs(t.amount);
    });
    var vat = charges * 0.15;
    document.getElementById('pnlRevenue').textContent = '$'+charges.toFixed(2);
    document.getElementById('pnlPayments').textContent = '$'+payments.toFixed(2);
    document.getElementById('pnlOutstanding').textContent = '$'+(charges - payments).toFixed(2);
    document.getElementById('pnlVAT').textContent = '$'+vat.toFixed(2);
    document.getElementById('pnlExVAT').textContent = '$'+(charges - vat).toFixed(2);
    document.getElementById('pnlRefunds').textContent = '$'+refunds.toFixed(2);
  }

  function openAddTxn(){
    document.getElementById('txn_date').value = new Date().toISOString().split('T')[0];
    document.getElementById('addTxnModal').classList.add('open');
  }
  function closeTxnModal(){ document.getElementById('addTxnModal').classList.remove('open'); }

  function submitTxn(){
    var ref = document.getElementById('txn_ref').value.trim();
    var desc = document.getElementById('txn_desc').value.trim();
    var amount = parseFloat(document.getElementById('txn_amount').value);
    var type = document.getElementById('txn_type').value;
    if(!ref||!desc||isNaN(amount)){alert('Fill all required fields');return;}
    if(type==='PAYMENT'||type==='REFUND') amount = -Math.abs(amount);

    var data = {reference:ref, date:document.getElementById('txn_date').value, description:desc, amount:amount, type:type, createdBy:'Admin'};

    if(typeof google !== 'undefined' && google.script && google.script.run){
      google.script.run.withSuccessHandler(function(r){
        if(r.success){closeTxnModal();loadTransactions();}
        else alert('Error: '+r.error);
      }).addTransaction(data);
    } else {
      transactions.push({id:'TXN-'+Math.random().toString(36).substr(2,8),reference:ref,date:data.date,description:desc,amount:amount,type:type,createdBy:'Admin',createdAt:new Date().toISOString()});
      closeTxnModal(); renderLedger();
    }
  }

  function deleteTxn(id){
    if(!confirm('Delete this transaction?')) return;
    if(typeof google !== 'undefined' && google.script && google.script.run){
      google.script.run.withSuccessHandler(function(r){
        if(r.success) loadTransactions();
        else alert('Error: '+r.error);
      }).deleteTransaction({transactionId:id,deletedBy:'Admin'});
    } else {
      transactions = transactions.filter(function(t){return t.id!==id;});
      renderLedger();
    }
  }

  function sendStatement(ref){
    var email = prompt('Send statement to email:');
    if(!email) return;
    if(typeof google !== 'undefined' && google.script && google.script.run){
      google.script.run.withSuccessHandler(function(r){alert(r.success?'Statement sent!':'Error: '+r.error);}).sendStatementEmail({reference:ref,email:email});
    } else { alert('Demo: Statement for '+ref+' would be sent to '+email); }
  }

  function loadTransactions(){
    if(typeof google !== 'undefined' && google.script && google.script.run){
      google.script.run.withSuccessHandler(function(r){
        transactions = r.transactions || [];
        document.getElementById('loadingState').style.display='none';
        renderLedger();
      }).withFailureHandler(function(e){
        document.getElementById('loadingState').innerHTML='Error: '+e.message;
      }).getAllTransactions();
    } else {
      transactions = [
        {id:'TXN-001',reference:'2602DEMO001',date:'2026-02-01',description:'Order: 1 item(s)',amount:89,type:'CHARGE',createdBy:'SYSTEM',createdAt:''},
        {id:'TXN-002',reference:'2602SMITH002',date:'2026-02-02',description:'Order: 2 item(s)',amount:358,type:'CHARGE',createdBy:'SYSTEM',createdAt:''},
        {id:'TXN-003',reference:'2602SMITH002',date:'2026-02-03',description:'PayPal Payment',amount:-358,type:'PAYMENT',createdBy:'SYSTEM',createdAt:''}
      ];
      document.getElementById('loadingState').style.display='none';
      renderLedger();
    }
  }

  loadTransactions();
</script>
</body>
</html>
